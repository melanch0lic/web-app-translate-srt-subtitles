<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    </head>

    <body>
        <script>
            // All render methods.
            window.Templates = {
                renderFileOption: function(fileItem) {
                    return '<option>' + fileItem.name + '</option>';
                },
                renderFileRow: function(fileRowItem) {
                    return '<tr>'
                        + '<td>' + fileRowItem.id + '</td>'
                        + '<td>' + fileRowItem.text + '</td>'
                        + '<td>' + fileRowItem.translation + '</td>'
                    '</tr>';
                }
            };
        </script>
        <script>
            
            function slugify(string){
                return string.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .split('')
                    .map(character => (/[a-z0-9]/.test(character) ? character : '-'))
                    .join('')
                    .replace(/-+/g,'-')
                    .replace(/^-|$/g,'')
            }
            $(function() {
                // Document loaded.

                // Handlers

                // Cache for source file records.
                var sourceFileRecords = [];

                $( "#id-source-files" ).change(function() {
                    // FIXME: Send request to correct endpoint and parse response.
                    $.ajax({
                        url: "http://127.0.0.1:8000/api/v1/files/"+slugify(this.value),  // FIXME: use correct endpoint.
                        dataType: 'json',
                        context: document.body
                    }).done(function(data) {
                        // FIXME: Use correct data
                        console.log(data.content)
                        var debugData = [
                            
                        ];
                        for (var i = 3; i < data.content.length; i = i + 4) {
                            if (data.content[i]===""){
                                debugData.push({id: data.content[i-3], text: data.content[i-1]})
                            }
                            else{
                                debugData.push({id: data.content[i-3], text: data.content[i-1] + " " +data.content[i]})
                                i++
                            }
                        }
                        var fileRows = debugData.map(window.Templates.renderFileRow);
                        console.log(fileRows);
                        $("#id-translation-table tbody").empty();
                        $("#id-translation-table tbody").append(fileRows);
                        sourceFileRecords = debugData;
                    });
                });

                $( "#id-target-files" ).change(function() {
                    // FIXME: Send request to correct endpoint and parse response.
                    $.ajax({
                        url: "http://127.0.0.1:8000/api/v1/files/"+slugify(this.value),  // FIXME: use correct endpoint.
                        dataType: 'json',
                        context: document.body
                    }).done(function(data) {
                        // FIXME: Use correct data
                        var debugData = [
                            
                        ];
                        for (var i = 3; i < data.content.length; i = i + 4) {
                            if (data.content[i]===""){
                                debugData.push({id: data.content[i-3], text: data.content[i-1]})
                            }
                            else{
                                debugData.push({id: data.content[i-3], text: data.content[i-1] + " " +data.content[i]})
                                i++
                            }
                        }
                        // join source and target records.
                        var joinedRecords = [];
                        var translation = '';
                        for (var i = 0; i < sourceFileRecords.length; ++i) {
                            if (i < debugData.length) {
                                translation = debugData[i].text;
                            } else {
                                translation = ''
                            }
                            joinedRecords.push({
                                id: sourceFileRecords[i].id,
                                text: sourceFileRecords[i].text,
                                translation: translation
                            })
                        }
                        var fileRows = joinedRecords.map(window.Templates.renderFileRow);
                        console.log(fileRows);
                        $("#id-translation-table tbody").empty();
                        $("#id-translation-table tbody").append(fileRows);
                    });
                });

                // end of handlers.

                // Fetch and display files.
                // FIXME: Should take file list from API.
                $.ajax({
                    url: "http://127.0.0.1:8000/api/v1/files",
                    context: document.body,
                    dataType: 'json',
                }).done(function(data) {

                    var debugData = [
                        
                    ];
                    $.each(data,function(index,value){
                        debugData.push(value)       
                    });
                    var fileOptions = debugData.map(window.Templates.renderFileOption);
                    $("#id-source-files").empty();
                    $("#id-source-files").append('<option>...</option>');
                    $("#id-source-files").append(fileOptions);

                    $("#id-target-files").empty();
                    $("#id-target-files").append('<option>...</option>');
                    $("#id-target-files").append(fileOptions);
                });
            });
        </script>

        <div id="layout">
            <div class="pure-g">
                <div class="pure-u-1 pure-u-md-1-3" style="width:50%" id="id-source-file">
                    <form class="pure-form pure-form-stacked">
                        <fieldset>
                            <div class="pure-g">
                                <div class="pure-u-1 pure-u-md-1-3">
                                    <label for="multi-state">Source file</label>
                                    <select id="id-source-files" class="pure-input-1-2">
                                        <option>...</option>
                                        <option>File1.srt</option>
                                        <option>File2.srt</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="pure-u-1 pure-u-md-1-3" style="width:50%" id="target-source-file">
                    <form class="pure-form pure-form-stacked">
                        <fieldset>
                            <div class="pure-g">
                                <div class="pure-u-1 pure-u-md-1-3">
                                    <label for="multi-state">Target file</label>
                                    <select id="id-target-files" class="pure-input-1-2">
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
        <table class="pure-table pure-table-horizontal" id="id-translation-table" style="width:100%">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Source</th>
                    <th>Translation</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </body>
</html>
